# üì∏ ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏£‡∏π‡∏õ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏•‡∏á chat_rooms

## üéØ ‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå

SQL ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏î‡∏∂‡∏á‡∏£‡∏π‡∏õ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏à‡∏≤‡∏Å `messages.metadata` ‡πÑ‡∏õ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡πÉ‡∏ô `chat_rooms`

---

## üöÄ ‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ

### 1Ô∏è‚É£ ‡πÄ‡∏õ‡∏¥‡∏î Supabase SQL Editor

```
Supabase Dashboard ‚Üí SQL Editor ‚Üí New Query
```

### 2Ô∏è‚É£ Copy SQL

```bash
# ‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü‡∏•‡πå
update-chat-rooms-profile.sql
```

### 3Ô∏è‚É£ ‡∏£‡∏±‡∏ô

```
‡∏Ñ‡∏•‡∏¥‡∏Å "Run" ‡∏´‡∏£‡∏∑‡∏≠ Ctrl+Enter
```

### 4Ô∏è‚É£ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå

```sql
-- ‡∏î‡∏π‡∏™‡∏£‡∏∏‡∏õ
SELECT 
  COUNT(*) as total_rooms,
  COUNT(customer_avatar) as has_avatar
FROM chat_rooms;
```

---

## üìä SQL ‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£

### ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó 3 ‡∏≠‡∏¢‡πà‡∏≤‡∏á:

1. **customer_name** ‚Üê `metadata.displayName`
2. **customer_avatar** ‚Üê `metadata.pictureUrl`
3. **metadata** ‚Üê ‡πÄ‡∏û‡∏¥‡πà‡∏° `statusMessage`, `language`

### ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á:

**‡∏Å‡πà‡∏≠‡∏ô:**
```json
{
  "customer_user_id": "Ua717abfa...",
  "customer_name": null,
  "customer_avatar": null
}
```

**‡∏´‡∏•‡∏±‡∏á:**
```json
{
  "customer_user_id": "Ua717abfa...",
  "customer_name": "Boy üòòüòô",
  "customer_avatar": "https://sprofile.line-scdn.net/...",
  "metadata": {
    "statusMessage": "‡πÄ‡∏£‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô‡∏Å‡∏î‡πÇ‡∏ó‡∏£‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö üòÖ",
    "language": "th",
    "profile_updated_at": "2025-11-01T09:22:00Z"
  }
}
```

---

## ‚úÖ ‡∏Ç‡πâ‡∏≠‡∏î‡∏µ

- ‚úÖ **‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°** (‡πÉ‡∏ä‡πâ COALESCE)
- ‚úÖ **‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î** (ORDER BY created_at DESC)
- ‚úÖ **‡∏£‡∏±‡∏ô‡∏ã‡πâ‡∏≥‡πÑ‡∏î‡πâ** (idempotent)
- ‚úÖ **‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢** (‡πÑ‡∏°‡πà‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•)

---

## üîÑ ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏´‡∏£‡πà‡∏Ñ‡∏ß‡∏£‡∏£‡∏±‡∏ô

### ‡∏£‡∏±‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å:
- ‚úÖ ‡∏´‡∏•‡∏±‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç workflow ‡πÉ‡∏´‡πâ‡πÄ‡∏Å‡πá‡∏ö metadata
- ‚úÖ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ

### ‡∏£‡∏±‡∏ô‡∏ã‡πâ‡∏≥ (Optional):
- ‚úÖ ‡∏ñ‡πâ‡∏≤‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏π‡∏õ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå
- ‚úÖ ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ chat_rooms ‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ
- ‚úÖ ‡∏ó‡∏∏‡∏Å‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£)

---

## üìù ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå

### 1. ‡∏™‡∏£‡∏∏‡∏õ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°
```sql
SELECT 
  COUNT(*) as total_rooms,
  COUNT(customer_avatar) as has_avatar
FROM chat_rooms;
```

### 2. ‡∏î‡∏π‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á
```sql
SELECT 
  customer_name,
  customer_avatar,
  metadata->>'statusMessage'
FROM chat_rooms
WHERE customer_avatar IS NOT NULL
LIMIT 5;
```

### 3. ‡∏î‡∏π‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ
```sql
SELECT 
  customer_user_id,
  customer_name
FROM chat_rooms
WHERE customer_avatar IS NULL;
```

---

## ‚ö†Ô∏è ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏£‡∏£‡∏∞‡∏ß‡∏±‡∏á

### ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô messages.metadata:

**‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏:**
- ‚ùå Workflow ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÅ‡∏Å‡πâ‡πÉ‡∏´‡πâ‡πÄ‡∏Å‡πá‡∏ö metadata
- ‚ùå ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤

**‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏Å‡πâ:**
1. ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Function Node ‡πÉ‡∏´‡πâ‡πÄ‡∏Å‡πá‡∏ö profile ‡πÉ‡∏ô metadata
2. ‡∏£‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡∏Å‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡πÉ‡∏´‡∏°‡πà
3. ‡∏£‡∏±‡∏ô SQL ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á

---

## üéØ ‡∏™‡∏£‡∏∏‡∏õ

### ‡πÑ‡∏ü‡∏•‡πå:
```
update-chat-rooms-profile.sql  ‚Üê ‡∏£‡∏±‡∏ô‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏µ‡πâ
```

### ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô:
1. ‡πÄ‡∏õ‡∏¥‡∏î Supabase SQL Editor
2. Copy SQL ‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå
3. ‡∏£‡∏±‡∏ô
4. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå

### ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå:
- ‚úÖ chat_rooms ‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡∏£‡∏π‡∏õ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå
- ‚úÖ ‡πÄ‡∏ß‡πá‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô
- ‚úÖ ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡∏Å‡∏°‡∏≤‡πÉ‡∏´‡∏°‡πà

---

**‡πÄ‡∏ã‡∏ü‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏µ‡πâ‡πÑ‡∏ß‡πâ ‡∏£‡∏±‡∏ô‡πÑ‡∏î‡πâ‡∏ó‡∏∏‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠!** üöÄ
